<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ ¡å›­åŠ©æ‰‹ Pro - äº‘ç«¯äº’è”ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- 1. ç½‘é¡µç²¾ç¾ UI æ ·å¼ (ä½ å–œæ¬¢çš„é‚£ä¸ªè®¾è®¡) --- */
        :root { --primary: #4f46e5; --secondary: #6366f1; --bg: #f3f4f6; --text: #1f2937; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, "SF Pro Text", "PingFang SC", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 30px; }

        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #e5e7eb; }
        .logo { font-size: 1.25rem; font-weight: 800; background: linear-gradient(45deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* åˆ†ç±»åˆ‡æ¢ */
        .tabs { display: flex; background: #e5e7eb; padding: 4px; border-radius: 25px; margin: 15px auto; width: 90%; max-width: 400px; }
        .tab { flex: 1; text-align: center; padding: 8px 0; font-size: 0.9rem; font-weight: 600; cursor: pointer; border-radius: 20px; transition: all 0.3s; color: #6b7280; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

        /* å†…å®¹åŒº */
        main { max-width: 600px; margin: 0 auto; padding: 0 15px; }
        .btn-pub { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); margin-bottom: 20px; }

        /* ç‰©å“å¡ç‰‡è®¾è®¡ */
        .card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-title { font-size: 1.1rem; font-weight: bold; color: #111827; display: block; margin-bottom: 4px; }
        .card-price { color: #dc2626; font-size: 1.3rem; font-weight: 800; margin: 8px 0; }
        .card-contact { font-size: 0.85rem; color: #4b5563; background: #f9fafb; padding: 8px; border-radius: 8px; display: inline-block; margin-top: 5px; }
        .card img { width: 100%; border-radius: 12px; margin-top: 12px; border: 1px solid #f3f4f6; object-fit: cover; max-height: 300px; }

        /* å‘å¸ƒå¼¹çª— */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); align-items: flex-end; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1rem; outline: none; transition: border 0.2s; }
        .form-input:focus { border-color: var(--primary); }

        .loading { text-align: center; color: #9ca3af; padding: 40px; font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <div class="logo">CAMPUS LIFE</div>
    <div style="font-size: 0.8rem; background: #eeeffe; color: var(--primary); padding: 4px 10px; border-radius: 10px; font-weight: bold;">å®æ—¶åŒæ­¥ä¸­</div>
</header>

<div class="tabs">
    <div class="tab active" onclick="switchTab('market', this)">äºŒæ‰‹äº¤æ˜“</div>
    <div class="tab" onclick="switchTab('carpool', this)">æ ¡å›­æ‹¼è½¦</div>
    <div class="tab" onclick="switchTab('jobs', this)">å…¼èŒä¿¡æ¯</div>
</div>

<main>
    <button class="btn-pub" onclick="toggleModal(true)">+ å‘å¸ƒæ–°æ¶ˆæ¯</button>
    <div id="itemList">
        <div class="loading">æ­£åœ¨ä»äº‘ç«¯è·å–æœ€æ–°å†…å®¹...</div>
    </div>
</main>

<div class="modal" id="pubModal">
    <div class="modal-content">
        <h3 style="margin-top:0">å‘å¸ƒåŠ¨æ€</h3>
        <div class="input-group">
            <label>æ ‡é¢˜</label>
            <input type="text" id="pTitle" class="form-input" placeholder="ä¾‹å¦‚ï¼šå‡ºä¹æˆæ–°iPad / è€ƒç ”èµ„æ–™">
        </div>
        <div class="input-group">
            <label>ä»·æ ¼/è´¹ç”¨ (Â¥)</label>
            <input type="text" id="pPrice" class="form-input" placeholder="å…è´¹è¯·å¡«0">
        </div>
        <div class="input-group">
            <label>è”ç³»æ–¹å¼ (å¾®ä¿¡/æ‰‹æœºå·)</label>
            <input type="text" id="pContact" class="form-input" placeholder="æ–¹ä¾¿ä»–äººè”ç³»ä½ ">
        </div>
        <div class="input-group">
            <label>ä¸Šä¼ å›¾ç‰‡/æ”¯ä»˜ç </label>
            <input type="file" id="pFile" class="form-input" accept="image/*" style="border:none; padding: 0;">
        </div>
        <button id="subBtn" class="btn-pub" style="margin-top: 10px;" onclick="handleSubmit()">ç«‹å³å‘å¸ƒåˆ°å…¨æ ¡</button>
        <button onclick="toggleModal(false)" style="width:100%; background:none; border:none; color:#9ca3af; padding:10px; cursor:pointer">å–æ¶ˆè¿”å›</button>
    </div>
</div>

<script>
    // --- 2. æ³¨å…¥ä½ çš„äº‘ç«¯é’¥åŒ™ (å·²ç¼åˆ) ---
    const S_URL = 'yJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlZmRlYWFveXpkdGpydHhrbnNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3ODYxNTAsImV4cCI6MjA4NjM2MjE1MH0.t8DzJGmPA8d1j-EnlPiwRcvBwVpAm1_03R9fGnHsSTg';
    const S_KEY = 'https://befdeaaoyzdtjrtxknsf.supabase.co';
    
    const client = supabase.createClient(S_URL, S_KEY);
    let currentCategory = 'market';

    // åˆ‡æ¢æ ‡ç­¾é¡µé€»è¾‘
    function switchTab(cat, el) {
        currentCategory = cat;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        loadData();
    }

    // ä»äº‘ç«¯åŠ è½½æ•°æ®
    async function loadData() {
        const listDiv = document.getElementById('itemList');
        listDiv.innerHTML = '<div class="loading">æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</div>';

        const { data, error } = await client
            .from('items')
            .select('*')
            .eq('category', currentCategory)
            .order('id', { ascending: false });

        if (error) {
            listDiv.innerHTML = '<div class="loading" style="color:red">è¿æ¥æ•°æ®åº“å¤±è´¥ï¼Œè¯·ç¡®è®¤åå° items è¡¨å·²åˆ›å»ºä¸” RLS å·²å…³é—­</div>';
            return;
        }

        listDiv.innerHTML = data.length ? '' : '<div class="loading">å½“å‰åˆ†ç±»è¿˜æ²¡æœ‰ä¿¡æ¯ï¼Œå¿«å»å‘å¸ƒå§ï¼</div>';
        
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <span class="card-title">${item.title}</span>
                <div class="card-price">Â¥ ${item.price}</div>
                <div class="card-contact">ğŸ’¬ ${item.contact}</div>
                ${item.image_url ? `<img src="${item.image_url}" loading="lazy">` : ''}
                <div style="font-size:0.7rem; color:#9ca3af; margin-top:12px;">ğŸ•’ å‘å¸ƒäº: ${new Date(item.created_at).toLocaleString()}</div>
            `;
            listDiv.appendChild(card);
        });
    }

    // æäº¤å‘å¸ƒé€»è¾‘
    async function handleSubmit() {
        const btn = document.getElementById('subBtn');
        const title = document.getElementById('pTitle').value.trim();
        const price = document.getElementById('pPrice').value.trim();
        const contact = document.getElementById('pContact').value.trim();
        const file = document.getElementById('pFile').files[0];

        if (!title || !price || !contact) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼Œæ–¹ä¾¿åˆ«äººæ‰¾åˆ°ä½ ');
        
        btn.innerText = "æ­£åœ¨åŒæ­¥äº‘ç«¯...";
        btn.disabled = true;

        try {
            let imgUrl = "";
            if (file) {
                const fileName = `${Date.now()}_${file.name}`;
                const { data: upData, error: upErr } = await client.storage.from('images').upload(fileName, file);
                if (upErr) throw upErr;
                const { data: pUrl } = client.storage.from('images').getPublicUrl(fileName);
                imgUrl = pUrl.publicUrl;
            }

            const { error: insErr } = await client.from('items').insert([{
                title, price, contact, category: currentCategory, image_url: imgUrl
            }]);

            if (insErr) throw insErr;

            alert('ğŸ‰ å‘å¸ƒæˆåŠŸï¼å…¨æ ¡ç”¨æˆ·åˆ·æ–°åå³å¯çœ‹åˆ°');
            toggleModal(false);
            loadData();
            // é‡ç½®è¡¨å•
            document.getElementById('pTitle').value = "";
            document.getElementById('pPrice').value = "";
            document.getElementById('pContact').value = "";
            document.getElementById('pFile').value = "";
        } catch (err) {
            alert('å‘å¸ƒé‡åˆ°äº†å°é—®é¢˜ï¼š' + err.message + '\nè¯·ç¡®è®¤å·²åœ¨ Supabase åˆ›å»º images å­˜å‚¨æ¡¶');
        } finally {
            btn.innerText = "ç«‹å³å‘å¸ƒåˆ°å…¨æ ¡";
            btn.disabled = false;
        }
    }

    function toggleModal(show) {
        document.getElementById('pubModal').classList.toggle('active', show);
    }

    // åˆå§‹åŠ è½½
    loadData();
</script>
</body>
</html>
